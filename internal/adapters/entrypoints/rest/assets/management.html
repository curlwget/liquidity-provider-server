<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Management UI</title>
    <link href="../static/Bootstrap.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        .main-content { margin-top: 20px; }
        pre {
            background-color: #f4f4f4; border: 1px solid #ddd;
            border-left: 3px solid #f36d33; color: #666;
            font-family: monospace; font-size: 14px;
            line-height: 1.4; padding: 0.5em 1em;
            overflow: auto; word-wrap: break-word;
        }
        .card, .compact-row { margin-bottom: 10px; }
        .card-title { font-size: 16px; }
        .card-text, .collateral-inputs, .collateral-buttons, .nav-tabs { margin-top: 10px; }
        .collateral-buttons button { margin-right: 10px; }
        .toast-container {
            position: fixed; bottom: 1rem; right: 1rem; z-index: 1060;
        }
        .small-label {
            font-size: 12px; color: grey; margin-left: 10px; display: inline-block; vertical-align: middle;
        }
        .input-container {
            display: flex; align-items: center;
        }
        .question-mark {
            font-size: 14px; color: gray; margin-left: 5px; cursor: help; position: relative;
        }
        .question-mark:hover .custom-tooltip {
            visibility: visible; opacity: 1;
        }
        .custom-tooltip {
            visibility: hidden; width: 200px; background-color: #333; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%;
            margin-left: -100px; opacity: 0; transition: opacity 0.3s;
        }
        .custom-tooltip::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent;
        }
        .nav{ margin-bottom: 1rem; }
        .loading-bar {
            display: none;
            height: 2px;
            background-color: #007bff;
            animation: loading 1s infinite;
        }
        @keyframes loading {
            0% { width: 0%; }
            50% { width: 50%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container main-content">
        <div class="row">
            <div class="col-md-12">
                <h1>Management Dashboard</h1><hr>
            </div>
        </div>
        <div class="row compact-row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Provider</div>
                    <div class="card-body">
                        <h5 class="card-title">Provider RSK Address</h5>
                        <p class="card-text" id="providerRskAddress"></p>
                        <h5 class="card-title">Provider BTC Address</h5>
                        <p class="card-text" id="providerBtcAddress"></p>
                        <h5 class="card-title">Operational Status</h5>
                        <p class="card-text" id="isOperational"></p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Collateral</div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="collateralTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" id="pegin-tab" data-bs-toggle="tab" href="#pegin" role="tab" aria-controls="pegin" aria-selected="true">Pegin</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="pegout-tab" data-bs-toggle="tab" href="#pegout" role="tab" aria-controls="pegout" aria-selected="false">Pegout</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="collateralTabContent">
                            <div class="tab-pane fade show active" id="pegin" role="tabpanel" aria-labelledby="pegin-tab">
                                <h5 class="card-title">Pegin Collateral</h5>
                                <p class="card-text" id="peginCollateral"></p>
                                <div class="collateral-inputs">
                                    <div class="mb-3">
                                        <label for="addPeginCollateralAmount" class="form-label">Add Pegin Collateral Amount</label>
                                        <input type="number" class="form-control" id="addPeginCollateralAmount" placeholder="Enter amount in rBTC">
                                    </div>
                                </div>
                                <div class="collateral-buttons">
                                    <button type="button" class="btn btn-primary" id="addPeginCollateralButton">Add Pegin Collateral</button>
                                    <div class="loading-bar" id="peginLoadingBar"></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="pegout" role="tabpanel" aria-labelledby="pegout-tab">
                                <h5 class="card-title">Pegout Collateral</h5>
                                <p class="card-text" id="pegoutCollateral"></p>
                                <div class="collateral-inputs">
                                    <div class="mb-3">
                                        <label for="addPegoutCollateralAmount" class="form-label">Add Pegout Collateral Amount</label>
                                        <input type="number" class="form-control" id="addPegoutCollateralAmount" placeholder="Enter amount in rBTC">
                                    </div>
                                </div>
                                <div class="collateral-buttons">
                                    <button type="button" class="btn btn-primary" id="addPegoutCollateralButton">Add Pegout Collateral</button>
                                    <div class="loading-bar" id="pegoutLoadingBar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Configuration</div>
                    <div class="card-body">
                        <h5 class="card-title">Current Configuration</h5>
                        <ul class="nav nav-tabs" id="configTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" id="general-tab" data-bs-toggle="tab" href="#general" role="tab" aria-controls="general" aria-selected="true">General</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="peginConfig-tab" data-bs-toggle="tab" href="#peginConfig" role="tab" aria-controls="peginConfig" aria-selected="false">Pegin</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="pegoutConfig-tab" data-bs-toggle="tab" href="#pegoutConfig" role="tab" aria-controls="pegoutConfig" aria-selected="false">Pegout</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="configTabContent">
                            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                                <div id="generalConfig"></div>
                            </div>
                            <div class="tab-pane fade" id="peginConfig" role="tabpanel" aria-labelledby="peginConfig-tab">
                                <div id="peginConfig"></div>
                            </div>
                            <div class="tab-pane fade" id="pegoutConfig" role="tabpanel" aria-labelledby="pegoutConfig-tab">
                                <div id="pegoutConfig"></div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="saveConfig">Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Configuration saved successfully!
            </div>
        </div>
    </div>

    <script src="../static/Bootstrap.js" crossorigin="anonymous"></script>
    <script src="../static/decimal.js" crossorigin="anonymous"></script>
    <script nonce="{{ .ScriptNonce }}">
        document.addEventListener('DOMContentLoaded', () => {
            const data = {{.}};
            const weiToEther = wei => {
                try {
                    const decimalValue = new Decimal(wei);
                    return decimalValue.dividedBy(new Decimal(1e18)).toString();
                } catch (error) {
                    throw new Error(`Failed to convert wei to ether. Input: "${wei}". Error: ${error.message}`);
                }
            };

            const etherToWei = ether => {
                if (typeof ether !== 'string' && typeof ether !== 'number') {
                    throw new TypeError(`Invalid input type for ether: ${typeof ether}. Expected a number or string.`);
                }
                try {
                    const num = new Decimal(ether);
                    if (num.isNegative()) {
                        throw new RangeError(`The input "${ether}" is not a valid number.`);
                    }
                    return num.times(new Decimal(1e18)).toFixed();
                } catch (error) {
                    throw new Error(`Failed to convert ether to wei. Input: "${ether}". Error: ${error.message}`);
                }
            };

            let generalChanged = false, peginChanged = false, pegoutChanged = false;

            const setTextContent = (id, text) => document.getElementById(id).textContent = text;

            const fetchData = async (url, elementId) => {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': data.CsrfToken
                        }
                    });
                    const responseData = await response.json();
                    setTextContent(elementId, weiToEther(responseData.collateral) + " rBTC");
                } catch (error) {
                    console.error(error);
                }
            };

            const populateProviderData = (providerData, rskAddress, btcAddress) => {
                setTextContent('providerRskAddress', rskAddress);
                setTextContent('providerBtcAddress', btcAddress);
                setTextContent('isOperational', providerData.status ? "Operational" : "Not Operational");
            };

            const createInput = (section, key, value) => {
                const div = document.createElement('div');
                div.classList.add('mb-3');

                const label = document.createElement('label');
                label.classList.add('form-label');
                label.textContent = key;

                const inputContainer = document.createElement('div');
                inputContainer.classList.add('input-container');

                const input = document.createElement('input');
                input.style.marginLeft = "10px";
                input.dataset.key = key;
                input.dataset.originalValue = value;

                if (typeof value === 'boolean') {
                    input.type = 'checkbox';
                    input.classList.add('form-check-input');
                    input.checked = value;
                    input.addEventListener('change', () => setChanged(section.id));
                } else {
                    input.type = 'text';
                    input.style.width = "40%";
                    input.classList.add('form-control');
                    input.value = formatValue(key, value);
                    input.addEventListener('input', () => setChanged(section.id));
                    if (isFeeKey(key)) {
                        const questionIcon = createQuestionIcon(getTooltipText(key));
                        label.appendChild(questionIcon);
                    }
                }

                inputContainer.appendChild(input);
                div.appendChild(label);
                div.appendChild(inputContainer);
                section.appendChild(div);
            };

            const createConfirmationConfig = (section, configKey, confirmations) => {
                const container = document.createElement('div');
                container.classList.add('confirmation-config');
                container.dataset.configKey = configKey;

                const header = document.createElement('h5');
                header.textContent = configKey;
                container.appendChild(header);

                const entriesContainer = document.createElement('div');
                entriesContainer.classList.add('entries-container');

                Object.entries(confirmations).forEach(([amountWei, confirmation], index) => {
                    createConfirmationEntry(entriesContainer, configKey, index, amountWei, confirmation);
                });

                container.appendChild(entriesContainer);

                const addButton = document.createElement('button');
                addButton.type = 'button';
                addButton.classList.add('btn', 'btn-secondary', 'mt-2');
                addButton.textContent = 'Add Entry';
                addButton.addEventListener('click', () => {
                    const index = entriesContainer.querySelectorAll('.input-group').length;
                    createConfirmationEntry(entriesContainer, configKey, index);
                    setChanged(configKey);
                });

                container.appendChild(addButton);
                section.appendChild(container);
            };

            const setChanged = (sectionId) => {
                if (sectionId === 'generalConfig') generalChanged = true;
                else if (sectionId === 'peginConfig') peginChanged = true;
                else if (sectionId === 'pegoutConfig') pegoutChanged = true;
                else if (sectionId === 'rskConfirmations' || sectionId === 'btcConfirmations') generalChanged = true;
            };

            const createQuestionIcon = (tooltipText) => {
                const questionIcon = document.createElement('span');
                questionIcon.classList.add('question-mark');
                const img = document.createElement('img');
                img.src = '../static/questionIcon.svg';
                img.width = 13;
                img.height = 13;
                img.alt = 'Question Mark';
                img.classList.add('bi', 'bi-question-circle');
                questionIcon.appendChild(img);
                const tooltip = document.createElement('div');
                tooltip.classList.add('custom-tooltip');
                tooltip.textContent = tooltipText;
                questionIcon.appendChild(tooltip);
                return questionIcon;
            };

            const getTooltipText = (key) => {
                const tooltips = {
                    timeForDeposit: 'The time (in seconds) for which a deposit is considered valid.',
                    expireTime: 'The time (in seconds) after which a quote is considered expired.',
                    penaltyFee: 'The penalty fee (in BTC) charged for invalid transactions.',
                    callFee: 'The fee (in BTC) charged by the LP for processing a transaction.',
                    maxValue: 'The maximum value (in BTC) allowed for a transaction.',
                    minValue: 'The minimum value (in BTC) allowed for a transaction.',
                    expireBlocks: 'The number of blocks after which a quote is considered expired.',
                    bridgeTransactionMin: 'The amount of rBTC that needs to be gathered in peg out refunds before executing a native peg out.'
                };
                return tooltips[key] || 'No description available';
            };

            const formatValue = (key, value) => {
                return isFeeKey(key) ? weiToEther(value) : value;
            };

            const isFeeKey = (key) => {
                return ['penaltyFee', 'callFee', 'maxValue', 'minValue', 'bridgeTransactionMin'].includes(key);
            };

            const createConfirmationEntry = (container, configKey, index, amount = '', confirmation = '') => {
                const div = document.createElement('div');
                div.classList.add('d-flex', 'align-items-center', 'mb-2');
                const fieldWidth = '180px';
                const amountGroup = document.createElement('div');
                amountGroup.classList.add('input-group', 'me-2');
                const amountInput = document.createElement('input');
                amountInput.type = 'text';
                amountInput.value = amount ? weiToEther(amount) : '';
                amountInput.classList.add('form-control', 'form-control-sm');
                amountInput.placeholder = 'Amount';
                amountInput.dataset.configKey = configKey;
                amountInput.dataset.field = 'amount';
                amountInput.dataset.index = index;
                amountInput.style.maxWidth = fieldWidth;
                const amountInputAppend = document.createElement('span');
                amountInputAppend.classList.add('input-group-text', 'input-group-text-sm');
                amountInputAppend.textContent = 'rBTC';
                amountGroup.appendChild(amountInput);
                amountGroup.appendChild(amountInputAppend);
                const confirmationGroup = document.createElement('div');
                confirmationGroup.classList.add('input-group', 'me-2');

                const confirmationInput = document.createElement('input');
                confirmationInput.type = 'number';
                confirmationInput.value = confirmation;
                confirmationInput.classList.add('form-control', 'form-control-sm');
                confirmationInput.placeholder = 'Confirmations';
                confirmationInput.dataset.configKey = configKey;
                confirmationInput.dataset.field = 'confirmation';
                confirmationInput.dataset.index = index;
                confirmationInput.style.maxWidth = fieldWidth;

                const confirmationInputAppend = document.createElement('span');
                confirmationInputAppend.classList.add('input-group-text', 'input-group-text-sm');
                confirmationInputAppend.textContent = 'confirmations';

                confirmationGroup.appendChild(confirmationInput);
                confirmationGroup.appendChild(confirmationInputAppend);


                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.classList.add('btn', 'btn-danger', 'btn-sm');
                removeButton.textContent = 'Remove';

                removeButton.addEventListener('click', () => {
                    div.remove();
                    setChanged(configKey);
                });

                amountInput.addEventListener('input', () => setChanged(configKey));
                confirmationInput.addEventListener('input', () => setChanged(configKey));

                div.appendChild(amountGroup);
                div.appendChild(confirmationGroup);
                div.appendChild(removeButton);
                container.appendChild(div);
            };

            const populateConfigSection = (sectionId, config) => {
                const section = document.getElementById(sectionId);
                section.innerHTML = '';
                Object.entries(config).forEach(([key, value]) => {
                    if (key === 'rskConfirmations' || key === 'btcConfirmations') createConfirmationConfig(section, key, value);
                    else createInput(section, key, value);
                });
            };

            const showSuccessToast = () => {
                const toastElement = document.getElementById('successToast');
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            };

            const showErrorToast = (errorMessage) => {
                const toastElement = document.createElement('div');
                toastElement.classList.add('toast');
                toastElement.setAttribute('role', 'alert');
                toastElement.setAttribute('aria-live', 'assertive');
                toastElement.setAttribute('aria-atomic', 'true');
                toastElement.innerHTML = `
                    <div class="toast-header">
                        <strong class="me-auto">Error</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${errorMessage}
                    </div>
                `;
                document.querySelector('.toast-container').appendChild(toastElement);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            };

            const inferType = value => {
                if (value === null || value === undefined) return 'undefined';
                if (Array.isArray(value)) return 'array';
                return typeof value;
            };

            const validateConfig = (config, originalConfig) => {
                const errors = [];
                Object.entries(config).forEach(([key, value]) => {
                    const expectedValue = originalConfig[key];
                    const expectedType = inferType(expectedValue);
                    let actualType = inferType(value);
                    if (isFeeKey(key)) if ((expectedType === 'number' && actualType === 'string') || (expectedType === 'string' && actualType === 'number')) actualType = expectedType;
                    if (expectedType !== 'undefined' && actualType !== expectedType) errors.push(`Invalid type for ${key}: expected ${expectedType}, got ${actualType}`);
                    if (key === 'rskConfirmations' || key === 'btcConfirmations') {
                        if (actualType !== 'object') {
                            errors.push(`Invalid type for ${key}: expected object, got ${actualType}`);
                        } else {
                            Object.entries(value).forEach(([subKey, subValue]) => {
                                const subActualType = inferType(subValue);
                                if (subActualType !== 'number') errors.push(`Invalid type for ${key} confirmation value of amount ${subKey}: expected number, got ${subActualType}`);
                            });
                        }
                    }
                });

                return { isValid: errors.length === 0, errors };
            };

            const saveConfig = async () => {
                const generalConfig = getConfig('generalConfig', formatGeneralConfig);
                const peginConfig = getConfig('peginConfig');
                const pegoutConfig = getConfig('pegoutConfig');
        
                let saveSuccess = true;
        
                const { isValid: isGeneralValid, errors: generalErrors } = validateConfig(generalConfig, data.Configuration.general);
                if (!isGeneralValid) {
                    showErrorToast(generalErrors.join('<br>'));
                    saveSuccess = false;
                } else if (generalChanged) {
                    const success = await postConfig('generalConfig', '/configuration', generalConfig);
                    saveSuccess = saveSuccess && success;
                }
        
                const { isValid: isPeginValid, errors: peginErrors } = validateConfig(peginConfig, data.Configuration.pegin);
                if (!isPeginValid) {
                    showErrorToast(peginErrors.join('<br>'));
                    saveSuccess = false;
                } else if (peginChanged) {
                    const success = await postConfig('peginConfig', '/pegin/configuration', peginConfig);
                    saveSuccess = saveSuccess && success;
                }
        
                const { isValid: isPegoutValid, errors: pegoutErrors } = validateConfig(pegoutConfig, data.Configuration.pegout);
                if (!isPegoutValid) {
                    showErrorToast(pegoutErrors.join('<br>'));
                    saveSuccess = false;
                } else if (pegoutChanged) {
                    const success = await postConfig('pegoutConfig', '/pegout/configuration', pegoutConfig);
                    saveSuccess = saveSuccess && success;
                }
        
                if (saveSuccess) showSuccessToast();
            };

            const getConfig = (sectionId, formatFunction) => {
                const inputs = document.getElementById(sectionId).querySelectorAll('input');
                const config = {};
                inputs.forEach(input => {
                    const configKey = input.dataset.configKey;
                    const index = input.dataset.index;
                    const field = input.dataset.field;
                    if (configKey === 'rskConfirmations' || configKey === 'btcConfirmations') {
                        if (!config[configKey]) config[configKey] = [];
                        if (!config[configKey][index]) config[configKey][index] = {};
                        if (field === 'amount') {
                            try {
                                config[configKey][index][field] = etherToWei(input.value).toString();
                            } catch (error) {
                                showErrorToast(`Invalid input "${input.value}" for field "Amount". Please enter a valid number.`);
                                throw error;
                            }
                        } else if (field === 'confirmation') {
                            const value = Number(input.value);
                            if (isNaN(value) || !Number.isInteger(value) || value < 0) {
                                showErrorToast(`Invalid input "${input.value}" for field "Confirmation". Please enter a valid non-negative integer.`);
                                throw new Error('Invalid confirmation number');
                            }
                            config[configKey][index][field] = value;
                        }
                    } else {
                        let value;
                        if (input.type === 'checkbox') {
                            value = input.checked;
                        } else {
                            if (isFeeKey(input.dataset.key)) {
                                try {
                                    value = etherToWei(input.value).toString();
                                } catch (error) {
                                    showErrorToast(`Invalid input "${input.value}" for field "${input.dataset.key}". Please enter a valid number.`);
                                    throw error;
                                }
                            } else {
                                value = input.value;
                                if (!isNaN(value) && !isNaN(parseFloat(value))) {
                                    value = Number(value);
                                }
                            }
                        }
                        config[input.dataset.key] = value;
                    }
                });
                if (formatFunction) return formatFunction(config);
                else return config;
            };

            const formatGeneralConfig = (config) => {
                const formattedConfig = {};
                Object.keys(config).forEach(key => {
                    if (key === 'rskConfirmations' || key === 'btcConfirmations') {
                        formattedConfig[key] = {};
                        config[key].forEach(entry => {
                            if (entry.amount && entry.confirmation !== undefined) {
                                formattedConfig[key][entry.amount] = entry.confirmation;
                            }
                        });
                    } else {
                        formattedConfig[key] = config[key];
                    }
                });
                return formattedConfig;
            };

            const postConfig = async (sectionId, endpoint, config) => {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': data.CsrfToken
                        },
                        body: JSON.stringify({
                            configuration: config
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        showErrorToast(`Error saving ${sectionId} configuration: ${errorData.message || 'Unknown error'}`);
                        return false;
                    }
                    return true;
                } catch (error) {
                    showErrorToast(`Error during ${sectionId} configuration save: ${error.message}`);
                    return false;
                }
            };

            const addCollateral = async (amountId, endpoint, elementId, loadingBarId, buttonId) => {
                const amountInEther = document.getElementById(amountId).value;
                const loadingBar = document.getElementById(loadingBarId);
                const button = document.getElementById(buttonId);
                loadingBar.style.display = 'block';
                button.disabled = true;
                try {
                    const amountInWei = Number(etherToWei(amountInEther));
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': data.CsrfToken },
                        body: JSON.stringify({ amount: amountInWei })
                    });
                    if (response.ok) {
                        fetchData(endpoint.replace('/addCollateral', '/collateral'), elementId);
                    } else {
                        const errorData = await response.json();
                        showErrorToast(`Error adding collateral: ${errorData.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    showErrorToast(`Invalid input "${amountInEther}" for collateral amount. Please enter a valid number.`);
                } finally {
                    loadingBar.style.display = 'none';
                    button.disabled = false;
                }
            };

            document.getElementById('addPeginCollateralButton').addEventListener('click', () => addCollateral('addPeginCollateralAmount', '/pegin/addCollateral', 'peginCollateral', 'peginLoadingBar', 'addPeginCollateralButton'));
            document.getElementById('addPegoutCollateralButton').addEventListener('click', () => addCollateral('addPegoutCollateralAmount', '/pegout/addCollateral', 'pegoutCollateral', 'pegoutLoadingBar', 'addPegoutCollateralButton'));
            document.getElementById('saveConfig').addEventListener('click', saveConfig);

            populateConfigSection('generalConfig', data.Configuration.general);
            populateConfigSection('peginConfig', data.Configuration.pegin);
            populateConfigSection('pegoutConfig', data.Configuration.pegout);
            populateProviderData(data.ProviderData, data.RskAddress, data.BtcAddress);
            fetchData('/pegin/collateral', 'peginCollateral');
            fetchData('/pegout/collateral', 'pegoutCollateral');
        });
    </script>
</body>
</html>
